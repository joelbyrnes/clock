<html>
<head>
    <title>Circular graphics</title>
    <!--<script src="https://code.createjs.com/createjs-2015.05.21.min.js"></script>-->
    <script src="static/createjs-2015.05.21.min.js"></script>
    <script src="static/dayclock.js"></script>
    <script src="static/moment.js"></script>

    <style>
        body {
            background: #000000;
        }

        /*horizontally center the canvas*/
        #demoCanvas {
            display: block;
            margin: 0 auto;
            background: #222222;
        }
    </style>
    <script>
        var canvas, stage;
        var face;
        var animate = true;
        var rotateFactor = 1;

        var midnight = time(0,0);
        var millis24hour = 24 * 60 * 60 * 1000;

        function init() {
            canvas = document.getElementById("demoCanvas");
            stage = new createjs.Stage(canvas);

            var xCenter = canvas.width / 2;
            var yCenter = canvas.height / 2;
            // more accurately, distance from xy and edge?
            var maxRadius = Math.floor(Math.min(canvas.width / 2, canvas.height / 2));

            face = new createjs.Container();
            stage.addChild(face);

            // TODO can get x y from face?
            draw(face, xCenter, yCenter, maxRadius);

            createjs.Ticker.addEventListener("tick", tick);
        }

        function draw(face, xCenter, yCenter, maxRadius) {

            var activities = [
                {name: "work",  start: time(9, 30),  end: time(18, 0),  color: "orange"},
                {name: "sleep", start: time(0, 0),   end: time(7, 30),  color: "blue"},
                {name: "foo",   start: time(18, 30), end: time(21, 30), color: "green"},
                {},
                {},
                {},
            ];

            var gap = Math.floor(maxRadius / 100);
            // for now every activity has its own layer - later, merge ones that don't overlap.
            var height = Math.floor((maxRadius - ((activities.length) * gap)) / (activities.length));

            var timeCells = [];
            for (var i=0; i < activities.length; i++) {
                console.log("adding activity layer " + i);
                var rad = (maxRadius - ((height + gap) * (i + 1)));
                var cell = createActivityCell(rad, height, activities[i]);
                console.log(cell);
                timeCells.push(cell)
            }

            // outer ring
//            face.addChild(createCell(xCenter, yCenter, {name: "outer", radius:maxRadius-2, height: 2, start: 0, end: 1, color: "#505090"}));

            addCells(face, xCenter, yCenter, timeCells);

            drawTimePassedShadow(face, xCenter, yCenter, maxRadius);
        }

        function createActivityCell(rad, defaultHeight, act) {
            var h = (act.height || 1) * defaultHeight;
            // adjust the rendering so midnight is at the top
            var start = ((act.start - midnight) / millis24hour) - 0.25;
            var end =  ((act.end - midnight) / millis24hour) - 0.25;
            return {name: act.name, radius: rad, height: h, start: start, end: end, color: act.color, alpha: act.alpha, rotateRate: act.rotateRate};
        }

        function drawTimePassedShadow(face, xCenter, yCenter, maxRadius) {
            var shadow = {name: "shadow", start: midnight, end: moment(), color: "#000000", alpha: 0.5};
//            console.log(shadow);
            face.addChild(createCell(xCenter, yCenter, createActivityCell(10, maxRadius, shadow)));
        }

        function time(hour, min) {
            return moment({hour: hour, minute: min});
        }

        function tick(event) {

            if (animate) {
                for (var i=0; i < face.numChildren; i++) {
                    var child = face.getChildAt(i);
                    child.rotation += child.rotateRate * rotateFactor;
                }

                stage.update(event);
            }
        }

    </script>
</head>
<body onload="init();">
<canvas id="demoCanvas" width="400" height="400"></canvas>
</body>
</html>